picotron cartridge // www.picotron.net
version 2

:: gfx/
:: map/
:: sfx/
:: main.lua
--[[pod_format="raw",created="2023-10-05 08:49:52",modified="2025-10-12 05:45:02",revision=29]]
local ce

function _draw()

	g:draw_all() -- covers whole screen; don't need to cls()

end

function _update()

	-- code editor always has keyboard focus when search is not open
	if (not ce:search_box_is_open()) ce:set_keyboard_focus(true)

	g:update_all()
	
end


function _init()

	-- default: variable width font
	poke(0x4000,get(fetch"/system/fonts/lil.font"))
	

	local icon=
	userdata"[gfx]08080777770077777700777777007777770077777700770000000777770000000000[/gfx]"

	window{
		width = 280,
		height = 200,
		--squashable = true, -- maybe optional later
		icon   = icon
	}
	

	g = create_gui()
	
	ce = g:attach_text_editor({
		x=0,y=0,
		width=get_display():width(),
		height=get_display():height(),
		width_rel  = 1.0,
		height_rel = 1.0,
		syntax_highlighting = false,
		show_line_numbers   = false,
		markup     = true,
		embed_pods = true,
		has_search = true,
		bgcol = 7,	
		fgcol = 5
	})



	ce:attach_scrollbars()
	
	wrangle_working_file(

		-- save to obj
		function ()
			-- setting an undo checkpoint here means can always undo back to a no-unsaved-changes state
			ce:get_undo_stack():checkpoint()
			-- convert from lines back to a single string
			return table.concat(ce:get_text(),"\n")
		end,

		-- load from obj (assumed to be a string)
		function (str)
			local text = split(str, "\n", false)
			--printh("str: ["..str.."]")
			--printh("notepad: loaded "..#text.." lines")
			if (not text or #text == 0) then text = {""} end
			ce:set_text(text)
		end,

		-- default file (and extension)
		"/desktop/untitled.txt", 

		-- get_hlocation
		nil,
		-- set_hlocation
		nil,

		--[[
			state_hint (optional):
			
			return a value that can be used to decide if there are unsaved changes.
			
			The return value can be anything, but should always change when the state 
			of the document *might* have changed.

			It should be very cheap; when the return value changes, a more expensive 
			state comparison is then performed by wranger to confirm that there are in 
			fact unsaved changes (which shows up as "*" in the window title")
			
			When this function is not provided, wrangler intead performs the full
			state comparison periodically (which is fine in most cases, but a bit 
			more expensive and the "*" doesn't show up straight away).

			Text fields created with :attach_text_editor provide their own state hint 
			function that can be used here, which uses a combination of undo stack 
			position and current line length:
			
			return #undo_stack.undo_stack + (#line[cur_y] << 8)

		]]
		function ()
			return ce and ce:get_state_hint()
		end


	)

end






:: untitled.txt
--[[pod_format="raw",created="2024-03-07 22:03:35",modified="2024-04-01 11:04:29",revision=3]]
fixme: default location shouldn't be /inside/ the app!


:: .info.pod
--[[pod,author="zep",created="2025-01-07 00:16:27",icon=userdata("u8",16,16,"0000010101010101010101010100000000010e0e0e0e0e0e0e0e0e0e0e0100000107010e0e0e0e0e0e0e0e0e0e0e01000001010e0e0e0e0e0e0e0e0e0e0e010000010e0e0e0e0e0e0e0e0e0e0e0e01000107010e0e0e0e0e0e0e0e0e0e0e01000001010e0e0e0e0e0e0e0e0e0e0e010000010e0e0e0e0e0e0e0e0e0e0e0e01000107010e0e0e0e0e0e0e0e0e0e0e01000001010e0e0e0e0e0e0e0e0e0e0e010000010e0e0e0e0e0e0e0e0e0e0e0e01000107010e0e0e0e0e0e0e0e0e0e01010000010101010101010101010101070100000101070707070707070707070e01000000010e0e0e0e0e0e0e0e0e0e01000000000001010101010101010101000000"),modified="2025-12-14 00:48:25",notes="write stuff",runtime=21,stored="2024-03-10 01:40:52",title="Notebook",version="",workspaces={{location="main.lua#103",workspace_index=1},{location="gfx/0.gfx",workspace_index=2},{location="map/0.map",workspace_index=3},{location="sfx/0.sfx",workspace_index=4}}]]
:: gfx/.info.pod
--[[pod,created="2023-10-05 08:48:44",modified="2025-12-14 00:48:25",stored="2023-48-05 08:48:44"]]
:: gfx/0.gfx
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDIzLTEwLTA1IDA4OjUwOjA4Iixtb2RpZmllZD0iMjAyNS0w
MS0wNyAwMDoxNjo1MiIscmV2aXNpb249MjBdXWx6NABtAAAABTEAAPMUe1swXT17Ym1wPXB4dQBD
IBAQBPDwLGZsYWdzPTAscGFuX3gIAM95PTAsem9vbT04fSwxAP--------------------------
-------------------------------------_dQbT04fX0=
:: map/.info.pod
--[[pod,created="2023-10-05 08:48:44",modified="2025-12-14 00:48:25",stored="2023-48-05 08:48:44"]]
:: map/0.map
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDIzLTEwLTA1IDA4OjUwOjA4Iixtb2RpZmllZD0iMjAyNS0w
MS0wNyAwMDoxNjo1MiIscmV2aXNpb249MjBdXWx6NABcAAAAWAQAAPAIe3tibXA9dXNlcmRhdGEo
ImkxNiIsMTYDAC8iMAEA----7-EIIiksaGlkZGVuPWZhbHNlLHBhbl94PTAIANJ5PTAsdGlsZV9o
PTE2CgAQdwoAgHpvb209MX19
:: map/map0.map
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDI0LTAzLTA2IDA5OjI1OjQ0Iixtb2RpZmllZD0iMjAyNC0w
My0wNiAwOToyNTo0NCIscmV2aXNpb249MF1dbHo0AGkAAACjCAAA8BN7bGF5ZXI9e1swXT17Ym1w
PXVzZXJkYXRhKCJpMTYiLDE2AwAvIjABAP---__hIikscGFuX3g9MAgA8gZ5PTAsc2NhbGU9MSx0
aWxlX2g9MTYKAG93PTE2fSxLBP----84UDE2fX19
:: sfx/.info.pod
--[[pod,created="2023-10-05 08:48:44",modified="2025-12-14 00:48:25",stored="2023-48-05 08:48:44"]]
:: sfx/0.sfx
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDIzLTEwLTEyIDEwOjU1OjExIixtb2RpZmllZD0iMjAyNS0w
MS0wNyAwMDoxNjo1MiIscmV2aXNpb249MTRdXWx6NABwAAAA7gcAAN9weHUAAygAAAQABPD-AQDs
-yfxARAGDyAQASABIAHwAAIQAg4QASAPISABMA9A8MMPKA--8MYP_AoP-w_AD-cPDQHwCQEQBg4w
AP85H-8BANzP_A9AAA8QQP--sPBwCwD--6Mf-wEA-5lQ-----yA=
:: sfx/sfx0.sfx
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDI0LTAzLTA2IDA5OjI1OjQ0Iixtb2RpZmllZD0iMjAyNC0w
My0wNiAwOToyNTo0NCIscmV2aXNpb249MF1dbHo0ABABAABRBwAA8CdweHUAAygAAAMABA9AEAIO
AAGgASACoA4ADxAADfDKAQIDBAUGBwEP-5AICQoLDwwPDQ8ODw8QAPAADQ8RDxIPEw8UDxUPFg8X
EwDxAQ8YDxkPGg8bDxwPHQ8eDx8UAPEAIA8hDyIPIw8kDyUPJg8nFADxACgPKQ8qDysPLA8tDy4P
LxQA8QAwDzEPMg8zDzQPNQ82DzcUAP8FOA85DzoPOw88Dz0PPg8-AQ--8P8BAOv-J1oBEAYPIBAB
IAEgAfAAAhACDBABIA8hIAEwD0Dwww8oD--wxg-4Cg--D4AP9w8NAfAJARAGDDAA-zkf-wEA3L-4
D0AADUD--7DwcAoA--9kH-8BAJdQ-----x8=
:: [eoc]
